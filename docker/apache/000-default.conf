<VirtualHost *:80>
    DocumentRoot /var/www/html
    ServerName localhost
    
    # Enable URL rewriting
    RewriteEngine On
    
    # Security: Block access to sensitive files and directories
    RewriteRule ^/(config|includes|logs|database)/ - [F,L]
    RewriteRule \.(sql|log|ini|env)$ - [F,L]
    
    # Allow static assets (CSS, JS, images) - serve directly
    RewriteRule ^/?(assets|css|js|images)/ - [L]
    RewriteRule \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ - [L]
    
    # API calls - allow direct access to .php files
    RewriteRule ^/?api/ - [L]
    
    # Allow direct access to auth directory
    RewriteRule ^/?auth/ - [L]
    
    # Main application routing - exclude API, auth directory and test files
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/auth/
    RewriteCond %{REQUEST_URI} !^/test
    RewriteCond %{REQUEST_URI} !^/password-test
    RewriteCond %{REQUEST_URI} !^/login-test
    RewriteCond %{REQUEST_URI} !^/campaign-test
    RewriteRule ^(.*)$ index.php [QSA,L]
    
    # Directory configuration
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
        
        # PHP handler
        <FilesMatch \.php$>
            SetHandler application/x-httpd-php
        </FilesMatch>
        
        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY" 
        Header always set X-XSS-Protection "1; mode=block"
        
        # Content Security Policy
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'"
        
        # Cache control for static assets
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
            Header set Cache-Control "public, max-age=31536000"
        </FilesMatch>
        
        # No cache for API and dynamic content
        <FilesMatch "\.(php)$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>
    </Directory>
    
    # API directory specific settings
    <Directory /var/www/html/api>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Ensure all API responses are treated as JSON
        Header always set Content-Type "application/json; charset=UTF-8"
    </Directory>
    
    # Protect sensitive directories
    <Directory /var/www/html/config>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/includes>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/database>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/logs>
        Require all denied
    </Directory>
    
    # Allow access to assets
    <Directory /var/www/html/assets>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Enable compression for text files
        <FilesMatch "\.(css|js)$">
            SetOutputFilter DEFLATE
        </FilesMatch>
    </Directory>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/initiate_error.log
    CustomLog ${APACHE_LOG_DIR}/initiate_access.log combined
    
    # Health check endpoint
    RewriteRule ^health$ /index.php?health=check [QSA,L]
</VirtualHost>